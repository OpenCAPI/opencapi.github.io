<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libocxl: Introduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libocxl
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Introduction </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>LibOCXL provides an access library which allows the user to implement a userspace driver for an <a href="http://opencapi.org/about/">OpenCAPI</a> accelerator.</p>
<h1>Features</h1>
<h2>Initialization</h2>
<p>AFUs may be opened using the device path or AFU name. If an multiple AFU instances with the same name are available, the first AFU found with available contexts will be used.</p>
<h2>Operation</h2>
<p>LibOCXL provides functions to attach to an AFU and transfer data to &amp; from the MMIO areas on the AFU. AFU IRQs can be queried either by IRQ handles, or by associating a callback to the IRQ.</p>
<h2>MMIO</h2>
<p>Functions are provide to allow 32 &amp; 64 bit access to the global and per-PASID MMIO areas on the the AFU. Endian conversion is handled automatically.</p>
<h1>Building</h1>
<h2>Prerequisites</h2>
<ol type="1">
<li>A GCC toolchain with libc (if cross compiling), crosstool-ng can build a suitable toolchain if your cross compiler does not include libc.</li>
<li><a href="http://www.stack.nl/~dimitri/doxygen/">Doxygen</a> 1.8.14 or later. Earlier versions will work, but don't generate enums in the man pages correctly.</li>
<li><a href="http://astyle.sourceforge.net/">Astyle</a>, if you plan on submitting patches.</li>
<li><a href="http://cppcheck.sourceforge.net/">CPPCheck</a>, if you plan on submitting patches.</li>
<li><a href="https://github.com/libfuse/libfuse">libFUSE</a>, to run tests</li>
</ol>
<h2>Included Dependencies</h2>
<ul>
<li>OCXL headers from the <a href="https://www.kernel.org/">Linux kernel</a></li>
</ul>
<h2>Build Instructions (Local build)</h2>
<ul>
<li><code>make</code></li>
<li><code>PREFIX=/usr/local make install</code></li>
</ul>
<h2>Build Instructions (Cross compilation)</h2>
<ul>
<li><code>export CROSS_COMPILE=/path/to/compiler/bin/powerpc64le-unknown-linux-gnu-</code></li>
<li><code>make</code></li>
</ul>
<h1>Usage</h1>
<p>A typical use of libocxl will follow this pattern:</p>
<ol type="1">
<li><b>Setup:</b> optionally turn on error reporting for the open calls: <a class="el" href="group__ocxl__messages.html#ga3a39ecd85ec5f67eba6f2a2590282f99" title="Enable messages from libocxl open calls. ">ocxl_enable_messages()</a>.</li>
<li><b>Open the device:</b> <a class="el" href="group__ocxl__afu.html#ga5633c8fa5d0a883434c953ee2b6d3e82" title="Open an AFU context with a specified name. ">ocxl_afu_open()</a> if an AFU name is used, or <a class="el" href="group__ocxl__afu.html#gaae8bcf00a06dc80ae37d2beb5a1451f6" title="Open an AFU context at a specified path. ">ocxl_afu_open_from_dev()</a> if a device path is used. Optionally turn on error reporting for the AFU: <a class="el" href="group__ocxl__messages.html#gae57c8b5f1b134df914d0647799a8e278" title="Enable messages from an AFU. ">ocxl_afu_enable_messages()</a>.</li>
<li><b>Allocate IRQs:</b> <a class="el" href="group__ocxl__irq.html#ga9985bc24e0893f4a57730d9582d79609" title="Allocate an IRQ for an open AFU. ">ocxl_irq_alloc()</a>. This returns a sequential per-AFU IRQ number. An opaque pointer is associated with the handle in which the caller can store additional information. This is not used by OpenCAPI, but is passed as part of the event information to provide additional context to the IRQ handler.</li>
<li><b>Configure global MMIO:</b> Some AFUs may have a global MMIO area, which will contain configuration information that will affect all PASIDs on the AFU. Use <a class="el" href="group__ocxl__mmio.html#ga6287a92804c0e6c9d58925155c948221" title="Map an MMIO area of an AFU. ">ocxl_mmio_map()</a> to make the area available, then use <a class="el" href="group__ocxl__mmio.html#ga633bb8d3c986e99ebc71b8156c3b87fd" title="Convert endianness and write a 32-bit value to an AFU&#39;s MMIO region. ">ocxl_mmio_write32()</a> and <a class="el" href="group__ocxl__mmio.html#ga21e8de35a2c9a76f90aff2442e742332" title="Convert endianness and write a 64-bit value to an AFU&#39;s MMIO region. ">ocxl_mmio_write64()</a> to write the information.</li>
<li><b>Configure the per-PASID MMIO:</b> Some AFUs support multiple contexts, and each context will get it's own MMIO area for configuration and communication. Typical information that may be communicated across the MMIO interface include IRQ handles (obtained with <a class="el" href="group__ocxl__irq.html#ga4e83b092e7905f25ec39f80370248c61" title="Get the 64 bit IRQ handle for an IRQ. ">ocxl_irq_get_handle()</a>), and pointers to AFU-specific data structures. Use ocxl_mmio_map to make the area available, then use <a class="el" href="group__ocxl__mmio.html#ga633bb8d3c986e99ebc71b8156c3b87fd" title="Convert endianness and write a 32-bit value to an AFU&#39;s MMIO region. ">ocxl_mmio_write32()</a> and <a class="el" href="group__ocxl__mmio.html#ga21e8de35a2c9a76f90aff2442e742332" title="Convert endianness and write a 64-bit value to an AFU&#39;s MMIO region. ">ocxl_mmio_write64()</a> to write the information.</li>
<li><b>Attach the AFU context to the process:</b> Use <a class="el" href="group__ocxl__afu.html#gab1b595ee41f713516ec0afd717e1db60" title="Attach the calling process&#39;s memory to an open AFU context. ">ocxl_afu_attach()</a> to make the process's address space available to the AFU context, allowing it to read &amp; write to the process's memory.</li>
<li><b>Signal the AFU to do some work:</b> This is typically done via a write into the per-PASID MMIO area.</li>
<li><b>Handle AFU IRQs:</b> Pending IRQs can be queried using <a class="el" href="group__ocxl__irq.html#ga394155027d19c0646b691080695a92ef" title="Check for pending IRQs and other events. ">ocxl_afu_event_check()</a>. An IRQ event contains the IRQ number, the info pointer assigned when activated, the 64 bit IRQ handle, and the number of times the IRQ has been triggered since last checked.</li>
<li><b>Read results:</b> Work completion may be signalled by the AFU via an IRQ, or by writing to the MMIO area. Typically, bulk data should be written to a pointer passed to the AFU, however, small quantities of data may be read from an MMIO area using <a class="el" href="group__ocxl__mmio.html#ga6a48836ea2ebd776c63f10327cb6de67" title="Read a 32-bit value from an AFU&#39;s MMIO region &amp; convert endianness. ">ocxl_mmio_read32()</a> and <a class="el" href="group__ocxl__mmio.html#ga4d5cd11344b3ba8c97a9c5274224032b" title="Read a 64-bit value from an AFU&#39;s MMIO region &amp; convert endianness. ">ocxl_mmio_read64()</a>.</li>
<li><b>Termination:</b> <a class="el" href="group__ocxl__afu.html#ga722157a2fe74a28f149ec51843a29009" title="Close an AFU and detach it from the context. ">ocxl_afu_close()</a> will free all resources associated with an AFU handle.</li>
</ol>
<h1>Development</h1>
<p>The following environment variables may be set (to 1 or "YES") to assist with development: <b>LIBOCXL_INFO</b> Print information about the LibOCXL build to stderr. This should be included in any bug reports. <b>LIBOCXL_TRACE_ALL</b> Force AFU interaction trace messages to be emitted for all AFUs unless explicitly disabled. <b>LIBOCXL_VERBOSE_ERRORS_ALL</b> Force verbose errors to be emitted for any failed LibOCXL calls, unless explicitly disabled.</p>
<p>Patches may be submitted via Github pull requests. Please prepare your patches by running <code>make precommit</code> before committing your work, and addressing any warnings &amp; errors reported. Patches must compile cleanly with the latest stable version of GCC to be accepted. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
